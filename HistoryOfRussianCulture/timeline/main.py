import matplotlib.pyplot as plt
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg, NavigationToolbar2Tk
from matplotlib.figure import Figure
from matplotlib.offsetbox import OffsetImage, AnnotationBbox
from matplotlib.dates import DateFormatter, num2date, date2num
from PIL import Image, ImageTk
from datetime import datetime, timedelta
import tkinter as tk

# Создаем данные для таймлайна
events = ["Становление христианства:\nСемь вселенских соборов:\nНикейский 325 г\nКонстантинопольский 381 г\nЭфесский 431 г\nХалкидонский 451 г\nПятый и Шестой Константинопольские – 553, 680 г.;\nпостановнения дополнил Трулльский 692 г.,\nставший как бы их продолжением\nСедьмой 787 г. – как первый, также проходивший в Никее", 
"476 год.\nПадение Западной Римской империи.\nОдоакра провозглашают королём.\nРис. Шарлотты Марии Йонг. ", 
"527 год.\nВосшествие на\nпрестол Юстиниана I Великого.\nЮстиниан вел активное\nстроительство по всей империи,\nименно при нем в Константинополе\nбыл построен собор Святой Софии.", 
"Расселение славян (IV–VII)", 
"Иордан или Иорданис,\nили (неправильно) Иорнанд,\nготский историк,\n† около 560 г,\nкоторый в своих работах упоминал народ\nРос (или Рус),\nвозможно, имея в виду восточнославянские племена",
"Период иконоборчества:\n1-й (730-787), 2-й (814-843)\nМиниатюра из Хлудовской псалтири:\nиконоборцы, замазывающие известью икону Христа.",
"768 год.\nСмерть Пипина Короткого,\nначало правления Карла Великого.\nПодъем культуры, начавшийся при Карле,\nполучил название «Каролингское возрождение».\nРасцвет Каролингской империи привел к\nраспространению западноевропейской \nкультуры и христианства\n(VIII-IX века)",
"В.М.Васнецов.\n«Призвание варягов. 862 г.» (Рюрика)\n1909 г.",
"Древняя Русь и Византия.\n907 (911) г.\nПереговоры об условиях договора между Олегом и\nвизантийскими императорами Львом VI\n и его братом Александром.\nМиниатюра из Радзивилловской летописи,\n конец XV века.",
"Правление Игоря (912-945)\nКлавдий Иванович Лебедев.\nКнязь Игорь собирает дань с древлян в 945 году\n(\"Полюдье\").1903 г.",
"НАЛОГОВАЯ РЕФОРМА КНЯГИНИ ОЛЬГИ \nс 945 по 946,\nзатем Принятие христианства Ольгой (957)",
"ДИПЛОМАТИЧЕСКИЕ СВЯЗИ С ВИЗАНТИЕЙ\nПриём императором Константином Багрянородным\nкнягини Ольги и её приближённых",
"ПРИНЯТИЕ ВЕРЫ ПРАВОСЛАВНОЙ ОТ ВИЗАНТИИ\nБеседа Ольги с византийским императором\nКонстантином Багрянородным;\nкрещение Ольги в Царьграде\n царем и патриархом.(955/957 гг.) ",
"962 год: Образование\n Священной Римской империи\nстало важным этапом в формировании \nполитической карты Европы.",
"Г.И.Семирадский\n«Тризна дружинников Святослава после боя под\nДоростолом в 971 году\n(Ночные жертвоприношения)». 1884 г.\nСмерть Святослава (972) ",
"Паломничество в Константинополь 986 год\nВыбор веры князем Владимиром. \nХуд. А. Ю. Филатов",
"Крещение Руси (988)\nМиниатюра XIV в. из среднеболгарского\nперевода летописи Константина Манассия",
"Путь «Из варяг в греки»\nНаибольшее значение путь «из варяг в греки»\nимел в X — первой трети XI века,\nво времена княжения\nСвятослава Игоревича и\nВладимира Святославича",
"Крестово-купольный храм\nВ IX-XII вв. – доминирующий в столице,\nи в провинции.\nЭтот тип храма будет развиваться и изменяться,\nперерабатываться на Руси",
"Десятинная церковь,\nили Храм Успения Пресвятой Богородицы\nвоздвигнутый Владимиром Святославичем\nв 989—996 годах ",
"В 1016 году появился главный\nправовой документ Древнерусского\nгосударства\"Русская Правда\",\nнаписанный Ярославом Мудрым", 
"1054\nВеликий князь киевский Ярослав расширяет Киев.\nМиниатюра из Радзивилловской летописи XV в", 
"Развитие феодализма в Западной Европе \n(X-XI века):\n1056 год.\nВосстание против германского короля Генриха IV\nК этому времени усилилась феодальная знать,\nзакрепившая за собой значительные земельные владения. ", 
"Расцвет культуры в Византии X-XII вв.\nАйя-София (Собор Святой Софии).\nВизантийские мозаики. - Стамбул", 
"Первый крестовый поход (1096-1099 годы)\nспособствовал укреплению связей между \nВосточной и Западной Европой\n1095 году после собора в Клермоне\nпапа выступил с пламенной речью перед\nпредставителями высшей знати и клира,\nпризвав освободить Святую Землю от мусульман и\nобещав участникам похода отпущение грехов",
"С. В. Иванов.\n«Съезд князей в Уветичах».\n1910 г.\nСъезд в Уветичах в августе 1100 года\nстал окончанием второй масштабной\nмеждоусобицы времен Владимира Мономаха",
"Правление Владимира Мономаха в Киеве\n(1113-1125)\nПортрет из Царского титулярника.\n1672 год",
"Распад Руси (1132 год):\nПосле смерти князя Мстислава Владимировича\nначался распад Руси на ряд\nсамостоятельных русских княжеств и земель. ",
"Развитие романского стиля в архитектуре\n(X-XII века)\nЗападной Европы оказало влияние на \nархитектурные традиции Древней Руси.",
"Князь Андрей Юрьевич Боголюбский в\n1157 году перенёс во \nВладимир столицу княжества",
"Развитие университетов в Западной Европе\n(XII-XIII века) способствовало\nраспространению образования \nи научных знаний.\n1198 год.\nНачало понтификата папы Иннокентия III",
"1204г. – Эжен Делакруа.\nВзятие Константинополя крестоносцами.\n1840 г.",
"Реформация церкви (X!-XII века)\nв Западной Европе привела к \nукреплению позиций папства.\n1212 год.\nНачало правления Фридриха II\nбыла ликвидирована независимость феодалов и городов,\nограничены права церкви,\nсоздан разветвленный чиновничий аппарат.",
"Битва на реке Калке (1223)\nМиниатюра Лицевого Летописного Свода",
"Северо-восточный поход Батыя (1237-1240)\nБольшинство русских земель\nподверглись разрушительному нашествию Батыя",
"Второй поход Батыя на Русь.\n1239-1240 гг.\nВ ходе монгольского нашествия был разрушен Киев,\nодин из ключевых центров Древней Руси",
"Расцвет городов и гильдий\n(XII-XIII века) в Западной Европе\nпривел к развитию торговли и ремесел.\n1261 год.\nПадение Латинской империи в Константинополе\nЛатинская империя была одним из\nсамых крупных государств крестоносцев",
"1261г. – возрождение\nВизантийской империи династией Палеологов.\nПравление Михаила VIII Палеолога",
"Развитие рыцарской культуры\n(XII-XIII века)\nв Западной Европе привело к формированию новых\nлитературных и искусственных традиций.\n1265 год.\nВозникновение английского парламента.\nправление Генриха III (1216–1272)",
"Развитие готического стиля в архитектуре\n(XII-XIII века)\nЗападной Европы оказало влияние на\nархитектурные традиции Древней Руси"]
dates = [datetime(381, 1, 1), datetime(476, 1, 1), datetime(527, 1, 1), datetime(550, 1, 1), datetime(560, 1, 1),
datetime(730, 1, 1), datetime(768, 1, 1), datetime(862, 1, 1), datetime(911, 1, 1), datetime(945, 1, 1), 
datetime(946, 1, 1), datetime(955, 1, 1), datetime(957, 1, 1), datetime(962, 1, 1), datetime(971, 1, 1), 
datetime(986, 1, 1), datetime(988, 1, 1), datetime(990, 1, 1), datetime(993, 1, 1), datetime(996, 1, 1), 
datetime(1016, 1, 1), datetime(1054, 1, 1), datetime(1056, 1, 1), datetime(1080, 1, 1), datetime(1096, 1, 1), 
datetime(1100, 1, 1), datetime(1120, 1, 1), datetime(1132, 1, 1), datetime(1140, 1, 1), datetime(1157, 1, 1), 
datetime(1198, 1, 1), datetime(1204, 1, 1), datetime(1212, 1, 1), datetime(1223, 1, 1), datetime(1237, 1, 1), 
datetime(1240, 1, 1), datetime(1260, 1, 1), datetime(1261, 1, 1), datetime(1265, 1, 1), datetime(1280, 1, 1)]
images = ['1.jpg', '2.jpg', '3.jpg', '4.jpg', '5.jpg', '6.jpg', '7.jpg', '8.jpg', '9.jpg', '10.jpg',
'11.jpg', '12.jpg', '13.jpg', '14.jpg', '15.jpg', '16.jpg', '17.jpg', '18.jpg', '19.jpg', '20.jpg',
'21.jpg', '22.jpg', '23.jpg', '24.jpg', '25.jpg', '26.jpg', '27.jpg', '28.jpg', '29.jpg', '30.jpg',
'31.jpg', '32.jpg', '33.jpg', '34.jpg', '35.jpg', '36.jpg', '37.jpg', '38.jpg', '39.jpg', '40.jpg']  # Список путей к изображениям

# Загружаем и изменяем размер изображений заранее
images_resized = []
for img_path in images:
    img = Image.open(img_path)
    img.thumbnail((1000, 1000))
    images_resized.append(img)

# Создаем окно Tkinter
root = tk.Tk()

# Создаем фигуру и оси
fig = Figure(figsize=(5, 4), dpi=100)
ax = fig.add_subplot(111)

# Рисуем таймлайн
ax.plot(dates, [0]*len(dates), 'o')  # Не отображаем подписи на графике

# Добавляем изображения к каждому событию
artists = []
for x, y, img in zip(dates, [0]*len(dates), images_resized):
    imagebox = OffsetImage(img, zoom=0.1)  # Создаем объект OffsetImage
    ab = AnnotationBbox(imagebox, (x, y))  # Создаем AnnotationBbox для размещения изображения
    ax.add_artist(ab)  # Добавляем изображение на график
    artists.append(ab)

# Создаем холст и добавляем его в окно Tkinter
canvas = FigureCanvasTkAgg(fig, master=root)
canvas.draw()
canvas.get_tk_widget().pack(side=tk.TOP, fill=tk.BOTH, expand=1)

# Убираем ось Y
ax.get_yaxis().set_visible(False)

# Создаем панель инструментов и добавляем ее в окно Tkinter
toolbar = NavigationToolbar2Tk(canvas, root)
toolbar.update()
canvas.get_tk_widget().pack(side=tk.TOP, fill=tk.BOTH, expand=1)

# Форматируем даты
class YearFormatter(DateFormatter):
    def __call__(self, x, pos=0):
        date_str = super().__call__(x, pos)
        return f'{date_str.lstrip("0")} г.'

ax.xaxis.set_major_formatter(YearFormatter('%Y'))

# Добавляем обработчик клика по изображению
def on_click(event):
    for i, artist in enumerate(artists):
        if artist.contains(event)[0]:
            if event.button == 1:  # Проверяем, что нажата левая кнопка мыши
                # При клике на изображение открываем его в новом окне
                new_window = tk.Toplevel(root)
                new_window.title("Image")
                img = images_resized[i]
                img = img.resize((800, 800), Image.LANCZOS)  # Изменяем размер изображения
                img = ImageTk.PhotoImage(img)
                panel = tk.Label(new_window, image=img)
                panel.image = img
                panel.pack(side="bottom", fill="both", expand="yes")
            elif event.button == 3:  # Проверяем, что нажата правая кнопка мыши
                # При клике на изображение выводим подпись во всплывающем окне
                new_window = tk.Toplevel(root)
                new_window.title("Event")
                label = tk.Label(new_window, text=events[i])
                label.pack(side="bottom", fill="both", expand="yes")

fig.canvas.mpl_connect('button_press_event', on_click)

# Показываем график
plt.show()

# Запускаем цикл обработки событий Tkinter
tk.mainloop()